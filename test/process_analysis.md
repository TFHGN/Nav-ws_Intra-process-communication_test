# å¯¼èˆªç³»ç»Ÿè¿›ç¨‹åˆ†æä¸ä¼˜åŒ–å»ºè®®

## æ‰§è¡Œå‘½ä»¤åˆ†æ
```bash
ros2 launch pb2025_nav_bringup rm_navigation_simulation_launch.py \
    world:=rmul_2025 \
    slam:=False \
    use_composition:=True  # é»˜è®¤ä¸ºTrue
```

---

## ä¸€ã€è¿›ç¨‹æ€»è§ˆ

### å½“å‰é…ç½®ï¼ˆuse_composition:=Trueï¼‰

#### ğŸ¯ **æ€»è®¡è¿›ç¨‹æ•°ï¼šçº¦ 9-10 ä¸ªè¿›ç¨‹**

| åºå· | è¿›ç¨‹åç§° | åŒ…å | ç±»å‹ | å¯åˆå¹¶æ€§ |
|------|---------|------|------|----------|
| 1 | **nav2_container** | rclcpp_components | å®¹å™¨ | âœ… å·²åˆå¹¶å®¹å™¨ |
| 2 | point_lio | point_lio | ç‹¬ç«‹è¿›ç¨‹ | âš ï¸ å¯è€ƒè™‘åˆå¹¶ |
| 3 | terrain_analysis | terrain_analysis | ç‹¬ç«‹è¿›ç¨‹ | âœ… å¯åˆå¹¶ |
| 4 | terrain_analysis_ext | terrain_analysis_ext | ç‹¬ç«‹è¿›ç¨‹ | âœ… å¯åˆå¹¶ |
| 5 | ign_sim_pointcloud_tool | ign_sim_pointcloud_tool | ç‹¬ç«‹è¿›ç¨‹ | âœ… å¯åˆå¹¶ |
| 6 | joy_node | joy | ç‹¬ç«‹è¿›ç¨‹ | âœ… å¯åˆå¹¶ |
| 7 | pb_teleop_twist_joy_node | pb_teleop_twist_joy | ç‹¬ç«‹è¿›ç¨‹ | âœ… å¯åˆå¹¶ |
| 8 | rviz2 | rviz2 | ç‹¬ç«‹è¿›ç¨‹ | âŒ ä¸å»ºè®®åˆå¹¶ |
| 9 | (gazebo) | gazebo | ä»¿çœŸå™¨ | âŒ å¤–éƒ¨è¿›ç¨‹ |

---

## äºŒã€è¯¦ç»†è¿›ç¨‹åˆ†æ

### ğŸ“¦ **å®¹å™¨å†…èŠ‚ç‚¹ï¼ˆnav2_containerï¼‰**

å®¹å™¨è¿›ç¨‹å†…åŒ…å«çš„ComposableNodeï¼ˆå…±äº«å†…å­˜ï¼Œé›¶æ‹·è´é€šä¿¡ï¼‰ï¼š

#### **å®šä½æ¨¡å— (localization_launch_test.py)**
1. **map_server** - åœ°å›¾æœåŠ¡å™¨
2. **buaa_sentry_relocalization** - åŒ—èˆªé‡å®šä½èŠ‚ç‚¹ï¼ˆç²—é…å‡†+ç²¾é…å‡†ï¼‰
3. **lifecycle_manager_localization** - å®šä½ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨

#### **å¯¼èˆªæ¨¡å— (navigation_launch.py)**
4. **loam_interface** - ç‚¹äº‘åæ ‡è½¬æ¢æ¥å£ (lidar_odom â†’ odom)
5. **sensor_scan_generation** - ç‚¹äº‘æ‰«æç”Ÿæˆ (odom â†’ front_mid360)
6. **fake_vel_transform** - è™šæ‹Ÿé€Ÿåº¦å‚è€ƒç³»ï¼ˆåº”å¯¹äº‘å°è‡ªæ—‹ï¼‰
7. **controller_server** - æ§åˆ¶å™¨æœåŠ¡å™¨
8. **smoother_server** - è·¯å¾„å¹³æ»‘æœåŠ¡å™¨
9. **planner_server** - å…¨å±€è§„åˆ’æœåŠ¡å™¨
10. **behavior_server** - è¡Œä¸ºæœåŠ¡å™¨
11. **bt_navigator** - è¡Œä¸ºæ ‘å¯¼èˆªå™¨
12. **waypoint_follower** - èˆªç‚¹è·Ÿéšå™¨
13. **velocity_smoother** - é€Ÿåº¦å¹³æ»‘å™¨
14. **lifecycle_manager_navigation** - å¯¼èˆªç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨

**å®¹å™¨å†…èŠ‚ç‚¹æ€»æ•°ï¼š14ä¸ª**

---

### ğŸ”§ **ç‹¬ç«‹è¿›ç¨‹èŠ‚ç‚¹**

#### **1. point_lio**
- **åŠŸèƒ½**ï¼šLiDARé‡Œç¨‹è®¡ï¼ˆåŸºäºLivox Mid360ï¼‰
- **ç‰¹ç‚¹**ï¼š
  - å®æ—¶æ€§è¦æ±‚é«˜
  - è®¡ç®—å¯†é›†å‹
  - å‘å¸ƒ `/cloud_registered` ç‚¹äº‘
- **æ˜¯å¦å¯åˆå¹¶**ï¼šâš ï¸ ç†è®ºä¸Šå¯ä»¥ï¼Œä½†ä¸æ¨è
  - **åŸå› **ï¼šä½œä¸ºå®šä½æºå¤´ï¼Œç‹¬ç«‹è¿›ç¨‹å¯ä»¥éš”ç¦»æ•…éšœ
  - **å»ºè®®**ï¼šä¿æŒç‹¬ç«‹

---

#### **2. terrain_analysis**
- **åŠŸèƒ½**ï¼šè¿‘è·ç¦»åœ°å½¢åˆ†æï¼ˆ4må†…ï¼‰
- **è¾“å…¥**ï¼šç‚¹äº‘æ•°æ®
- **è¾“å‡º**ï¼šéšœç¢ç‰©ç¦»åœ°é«˜åº¦ï¼ˆå†™å…¥intensityå­—æ®µï¼‰
- **æ˜¯å¦å¯åˆå¹¶**ï¼šâœ… **å¼ºçƒˆæ¨èåˆå¹¶åˆ°å®¹å™¨**
  - å¯ä½œä¸ºComposableNodeåŠ å…¥nav2_container
  - ä¸sensor_scan_generationå…±äº«å†…å­˜ï¼Œå‡å°‘ç‚¹äº‘æ‹·è´å¼€é”€

---

#### **3. terrain_analysis_ext**
- **åŠŸèƒ½**ï¼šè¿œè·ç¦»åœ°å½¢åˆ†æï¼ˆ4må¤–ï¼‰
- **æ˜¯å¦å¯åˆå¹¶**ï¼šâœ… **å¼ºçƒˆæ¨èåˆå¹¶åˆ°å®¹å™¨**
  - ä¸terrain_analysisåˆå¹¶ç­–ç•¥ç›¸åŒ
  - å¯è¿›ä¸€æ­¥ä¼˜åŒ–ä¸ºå•ä¸€èŠ‚ç‚¹å¤„ç†å…¨èŒƒå›´

---

#### **4. ign_sim_pointcloud_tool**
- **åŠŸèƒ½**ï¼šä»¿çœŸç‚¹äº‘ä¿®å¤å·¥å…·ï¼ˆæ·»åŠ `time`å­—æ®µï¼‰
- **é€‚ç”¨ç¯å¢ƒ**ï¼šä»…ä»¿çœŸ
- **æ˜¯å¦å¯åˆå¹¶**ï¼šâœ… **å¯åˆå¹¶**
  - ä»…åœ¨ä»¿çœŸæ—¶å¯åŠ¨
  - å¯ä½œä¸ºComposableNodeåŠ å…¥å®¹å™¨

---

#### **5. joy_node + pb_teleop_twist_joy_node**
- **åŠŸèƒ½**ï¼šæ‰‹æŸ„æ§åˆ¶
- **ç‰¹ç‚¹**ï¼šé¢‘ç‡20Hzï¼Œä½å»¶è¿Ÿè¦æ±‚
- **æ˜¯å¦å¯åˆå¹¶**ï¼šâœ… **å¯åˆå¹¶**
  - ä¸¤ä¸ªèŠ‚ç‚¹å¯ä»¥åˆå¹¶åˆ°å•ç‹¬çš„"teleop_container"
  - æˆ–åŠ å…¥nav2_containerï¼ˆè‹¥ä¸å½±å“å®æ—¶æ€§ï¼‰

---

#### **6. rviz2**
- **åŠŸèƒ½**ï¼šå¯è§†åŒ–ç•Œé¢
- **æ˜¯å¦å¯åˆå¹¶**ï¼šâŒ **ä¸å»ºè®®åˆå¹¶**
  - ç‹¬ç«‹GUIè¿›ç¨‹
  - å´©æºƒä¸åº”å½±å“å¯¼èˆªæ ¸å¿ƒ

---

## ä¸‰ã€ä¼˜åŒ–å»ºè®®

### ğŸ¯ **æ¨èåˆå¹¶æ–¹æ¡ˆ**

#### **æ–¹æ¡ˆAï¼šæ¿€è¿›åˆå¹¶ï¼ˆæœ€å°‘è¿›ç¨‹æ•°ï¼š5-6ä¸ªï¼‰**

```
è¿›ç¨‹1: nav2_containerï¼ˆæ‰©å±•ç‰ˆï¼‰
  â”œâ”€â”€ åŸæœ‰14ä¸ªNAV2èŠ‚ç‚¹
  â”œâ”€â”€ terrain_analysis
  â”œâ”€â”€ terrain_analysis_ext
  â”œâ”€â”€ ign_sim_pointcloud_tool (ä»…ä»¿çœŸ)
  â””â”€â”€ joyç›¸å…³èŠ‚ç‚¹ (å¯é€‰)

è¿›ç¨‹2: point_lio (ç‹¬ç«‹)
è¿›ç¨‹3: rviz2 (ç‹¬ç«‹)
è¿›ç¨‹4: gazebo (ä»¿çœŸå™¨)
è¿›ç¨‹5: joy_node (å¦‚æœä¸åŠ å…¥å®¹å™¨)
è¿›ç¨‹6: pb_teleop_twist_joy_node (å¦‚æœä¸åŠ å…¥å®¹å™¨)
```

**ä¼˜ç‚¹**ï¼š
- æœ€å°‘è¿›ç¨‹æ•°ï¼ˆ5-6ä¸ªï¼‰
- æœ€å¤§åŒ–é›¶æ‹·è´é€šä¿¡ä¼˜åŠ¿
- ç‚¹äº‘æ•°æ®åœ¨å®¹å™¨å†…å…±äº«ï¼Œå‡å°‘åºåˆ—åŒ–å¼€é”€

**ç¼ºç‚¹**ï¼š
- å®¹å™¨å†…ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹å´©æºƒå¯èƒ½å½±å“å…¨éƒ¨
- è°ƒè¯•ç¨å¾®å¤æ‚

---

#### **æ–¹æ¡ˆBï¼šä¿å®ˆåˆå¹¶ï¼ˆæ¨èï¼Œè¿›ç¨‹æ•°ï¼š7-8ä¸ªï¼‰**

```
è¿›ç¨‹1: nav2_container
  â”œâ”€â”€ åŸæœ‰14ä¸ªNAV2èŠ‚ç‚¹
  â”œâ”€â”€ terrain_analysis
  â””â”€â”€ terrain_analysis_ext

è¿›ç¨‹2: perception_container (æ–°å¢å®¹å™¨)
  â”œâ”€â”€ ign_sim_pointcloud_tool
  â”œâ”€â”€ loam_interface (ä»nav2_containerç§»å‡º)
  â””â”€â”€ sensor_scan_generation (ä»nav2_containerç§»å‡º)

è¿›ç¨‹3: teleop_container (æ–°å¢å®¹å™¨)
  â”œâ”€â”€ joy_node
  â””â”€â”€ pb_teleop_twist_joy_node

è¿›ç¨‹4: point_lio (ç‹¬ç«‹)
è¿›ç¨‹5: rviz2 (ç‹¬ç«‹)
è¿›ç¨‹6: gazebo (ä»¿çœŸå™¨)
```

**ä¼˜ç‚¹**ï¼š
- æŒ‰åŠŸèƒ½åˆ†ç¦»å®¹å™¨ï¼Œæ•…éšœéš”ç¦»æ›´å¥½
- æ„ŸçŸ¥ã€æ§åˆ¶ã€å¯¼èˆªä¸‰å±‚è§£è€¦
- ä»èƒ½äº«å—è¿›ç¨‹å†…é€šä¿¡ä¼˜åŠ¿

**ç¼ºç‚¹**ï¼š
- è¿›ç¨‹æ•°ç•¥å¤š
- è·¨å®¹å™¨é€šä¿¡ä»éœ€åºåˆ—åŒ–

---

#### **æ–¹æ¡ˆCï¼šå½“å‰ä¿æŒï¼ˆè¿›ç¨‹æ•°ï¼š9-10ä¸ªï¼‰**

å¦‚æœç³»ç»Ÿç¨³å®šè¿è¡Œï¼Œå½“å‰é…ç½®ä¹Ÿæ˜¯å¯æ¥å—çš„ã€‚

---

## å››ã€å®æ–½æ­¥éª¤

### **Step 1: åˆå¹¶ terrain_analysis**

ä¿®æ”¹ `navigation_launch.py`ï¼Œå°† terrain_analysis ä»ç‹¬ç«‹Nodeæ”¹ä¸ºComposableNodeï¼š

```python
# åˆ é™¤ç‹¬ç«‹å¯åŠ¨éƒ¨åˆ†
# start_terrain_analysis_cmd = Node(...)

# åœ¨ load_composable_nodes ä¸­æ·»åŠ 
ComposableNode(
    package="terrain_analysis",
    plugin="terrainAnalysis::TerrainAnalysisNode",  # éœ€ç¡®è®¤æ’ä»¶ç±»å
    name="terrain_analysis",
    parameters=[configured_params],
    extra_arguments=[{'use_intra_process_comms': True}],
),
ComposableNode(
    package="terrain_analysis_ext",
    plugin="terrainAnalysisExt::TerrainAnalysisExtNode",
    name="terrain_analysis_ext",
    parameters=[configured_params],
    extra_arguments=[{'use_intra_process_comms': True}],
),
```

**å‰æ**ï¼šterrain_analysis å¿…é¡»æ”¯æŒComposableNodeæ¥å£ã€‚

---

### **Step 2: éªŒè¯æ˜¯å¦æ”¯æŒComposable**

æ£€æŸ¥ `terrain_analysis/CMakeLists.txt`ï¼š
```cmake
# éœ€è¦æœ‰ç±»ä¼¼è¿™æ ·çš„ä»£ç 
rclcpp_components_register_nodes(terrain_analysis 
    "terrainAnalysis::TerrainAnalysisNode")
```

å¦‚æœä¸æ”¯æŒï¼Œéœ€è¦é‡æ„ä¸ºComposableNodeã€‚

---

### **Step 3: æµ‹è¯•ä¸éªŒè¯**

```bash
# å¯åŠ¨åæ£€æŸ¥è¿›ç¨‹æ•°
ps aux | grep ros2 | wc -l

# æŸ¥çœ‹å®¹å™¨å†…èŠ‚ç‚¹
ros2 component list

# ç›‘æ§CPUå’Œå†…å­˜
top -p $(pgrep -f nav2_container)
```

---

## äº”ã€æ€§èƒ½å¯¹æ¯”é¢„æµ‹

### **å½“å‰é…ç½® vs ä¼˜åŒ–å**

| æŒ‡æ ‡ | å½“å‰ | æ–¹æ¡ˆA | æ–¹æ¡ˆB |
|------|------|-------|-------|
| **è¿›ç¨‹æ€»æ•°** | 9-10 | 5-6 | 7-8 |
| **ç‚¹äº‘æ‹·è´æ¬¡æ•°** | é«˜ | ä½ | ä¸­ |
| **å†…å­˜å ç”¨** | åŸºå‡† | -15~20% | -10~15% |
| **CPUå¼€é”€** | åŸºå‡† | -5~10% | -3~5% |
| **é€šä¿¡å»¶è¿Ÿ** | åŸºå‡† | -30~40% | -20~30% |
| **æ•…éšœéš”ç¦»æ€§** | å¥½ | ä¸­ | å¥½ |
| **è°ƒè¯•éš¾åº¦** | ä½ | ä¸­ | ä½ |

---

## å…­ã€ä¸å¯åˆå¹¶çš„èŠ‚ç‚¹

ä»¥ä¸‹èŠ‚ç‚¹**ä¸åº”**åˆå¹¶åˆ°å®¹å™¨ï¼š

1. **point_lio** - ä½œä¸ºé‡Œç¨‹è®¡æºå¤´ï¼Œç‹¬ç«‹æ€§ä¿è¯é²æ£’æ€§
2. **rviz2** - GUIè¿›ç¨‹ï¼Œå´©æºƒä¸åº”å½±å“æ ¸å¿ƒåŠŸèƒ½
3. **gazebo** - å¤–éƒ¨ä»¿çœŸå™¨
4. **robot_state_publisher** (å¦‚æœå¯ç”¨) - é€šå¸¸ç‹¬ç«‹è¿è¡Œ

---

## ä¸ƒã€æ£€æŸ¥å‘½ä»¤

### æŸ¥çœ‹å½“å‰è¿è¡Œçš„èŠ‚ç‚¹
```bash
ros2 node list
```

### æŸ¥çœ‹å®¹å™¨å†…çš„ç»„ä»¶
```bash
ros2 component list
```

### æŸ¥çœ‹è¿›ç¨‹æ ‘
```bash
pstree -p $(pgrep -f nav2_container)
```

### ç›‘æ§è¿›ç¨‹èµ„æº
```bash
# å®æ—¶ç›‘æ§
htop -p $(pgrep -f "ros2|point_lio|rviz2" | tr '\n' ',')

# æˆ–ä½¿ç”¨ ros2 å·¥å…·
ros2 node info /<namespace>/nav2_container
```

---

## å…«ã€æ€»ç»“

### âœ… **æ¨èä¼˜åŒ–æ–¹æ¡ˆ**

é‡‡ç”¨ **æ–¹æ¡ˆBï¼ˆä¿å®ˆåˆå¹¶ï¼‰**ï¼š
- âœ… å°† terrain_analysis ç³»åˆ—åˆå¹¶åˆ° nav2_container
- âœ… å°†æ‰‹æŸ„æ§åˆ¶èŠ‚ç‚¹åˆå¹¶åˆ°ç‹¬ç«‹çš„ teleop_container
- âœ… ä¿æŒ point_lioã€rviz2 ç‹¬ç«‹è¿è¡Œ

### ğŸ“Š **é¢„æœŸæ”¶ç›Š**
- è¿›ç¨‹æ•°ä» **9-10ä¸ª** é™è‡³ **7-8ä¸ª**
- ç‚¹äº‘å¤„ç†é“¾è·¯é›¶æ‹·è´ï¼Œå»¶è¿Ÿé™ä½ **20-30%**
- å†…å­˜å ç”¨å‡å°‘ **10-15%**

### âš ï¸ **æ³¨æ„äº‹é¡¹**
1. ç¡®è®¤æ‰€æœ‰è¦åˆå¹¶çš„èŠ‚ç‚¹æ”¯æŒ `rclcpp_components`
2. æµ‹è¯•æ—¶é€æ­¥åˆå¹¶ï¼Œé¿å…ä¸€æ¬¡æ€§å¤§æ”¹
3. ç›‘æ§å®¹å™¨å†…èŠ‚ç‚¹å´©æºƒå¯¹å…¶ä»–èŠ‚ç‚¹çš„å½±å“
4. å¯¹äºå®æ—¶æ€§è¦æ±‚æé«˜çš„èŠ‚ç‚¹ï¼ˆå¦‚point_lioï¼‰ï¼Œå»ºè®®ä¿æŒç‹¬ç«‹

---

**ç”Ÿæˆæ—¥æœŸ**: 2025-11-09  
**åˆ†æåŸºäº**: pb2025_sentry_nav å½“å‰ç‰ˆæœ¬
